---
title: "Correlations across adjacent stages within cell types"
author: "Ioannis Sarropoulos"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(RColorBrewer)
  library(viridis)
  library(ComplexHeatmap)
  library(data.table)
})
```

A caveat of identifying periods of greater change through the numbers of differentially accessible CREs is that our ability to call differential accessibility decreases in low cell numbers.

To compensate for this, we can also detect periods of change (i.e. periods of extensive dissimilarity) using correlations. In contrast to DA calling, correlations will be lower in low cell numbers (opposite bias to DA calling).

Thus, if our developmental patterns largely overlap, we gain more confidence about the presence of greater change in the periods we propose.

```{r}
atac.cpm <- read.table("~/Mouse_Cereb/013_globalCREactivity/Mouse_lineage_by_timepoint_pseudobulk_cpm.txt", header = T, sep = "\t", stringsAsFactors = F)

## We will use Pearson's correlations to give more weight to radical changes. However, when using parametric tests it's advantageous to log-transform the data.
atac.cpm <- log10(atac.cpm + 1)

## Keeping only the comparisons where we had adequate reads (also tested in dev. peaks):
ct <- c("Astroglia", "GABA_DN", "Glut_DN","PC", "Interneuron", "GC")

all.gather <- Reduce(bind_rows, lapply(ct, function(x) {
  f <-readRDS(paste0("~/Mouse_Cereb/012_devPeaks/byCellType/", x, "/", x, "_pseudobulk_byTimepoint_deseq_results.rds"))
  f.gather <- gather(f, -peak, key = "timepoint", value = "sign", na.rm = F) %>%
  mutate(timepoint=factor(timepoint), sign=factor(sign)) %>%
  filter(sign %in% c("up", "down")) %>%
  group_by(timepoint, sign, .drop = FALSE) %>%
    dplyr::count() %>%
  ungroup() %>%
  filter(sign %in% c("up", "down")) %>%
    droplevels()
  f.gather$Cell_type <- x
  return(f.gather)
}))

all.gather$timepoint <- sapply(all.gather$timepoint, function(x) gsub("_", "-", x))
all.gather$timepoint <- sapply(all.gather$timepoint, function(x) gsub("P04", "P4", x))
all.gather$timepoint <- sapply(all.gather$timepoint, function(x) gsub("P07", "P7", x))
all.gather$sample <- paste(all.gather$Cell_type, all.gather$timepoint, sep = "_")

cor_adj_by_cell_type <- do.call(rbind, lapply(ct, function(ct) {
  d <- atac.cpm[, grepl(ct, colnames(atac.cpm))]
  colnames(d) <- gsub(paste0(ct, "_"), "",colnames(d))
  cor <- cor(d, method = "pearson")
  cor_adj <-  c(tryCatch(cor["e10", "e11"], error=function(cond) {return(NA)}) ,
                   tryCatch(cor["e11", "e12"], error=function(cond) {return(NA)}) ,
                   tryCatch(cor["e12", "e13"], error=function(cond) {return(NA)}) ,
                   tryCatch(cor["e13", "e15"], error=function(cond) {return(NA)}),
                   tryCatch(cor["e15", "e17"], error=function(cond) {return(NA)}),
                   tryCatch(cor["e17", "P0"], error=function(cond) {return(NA)}),
                   tryCatch(cor["P0", "P04"], error=function(cond) {return(NA)}),
                   tryCatch(cor["P04", "P07"], error=function(cond) {return(NA)}),
                   tryCatch(cor["P07", "P14"], error=function(cond) {return(NA)}),
                   tryCatch(cor["P14", "P63"], error=function(cond) {return(NA)}))
  
  return(cor_adj)
}))

colnames(cor_adj_by_cell_type) <- c("e10-e11",
                              "e11-e12",
                              "e12-e13",
                              "e13-e15",
                              "e15-e17",
                              "e17-P0",
                              "P0-P4",
                              "P4-P7",
                              "P7-P14",
                              "P14-P63")
row.names(cor_adj_by_cell_type) <- ct

pheatmap::pheatmap(cor_adj_by_cell_type, cluster_rows = F, cluster_cols = F)

cor_adj_by_cell_type.gather <- as.data.frame(cor_adj_by_cell_type) %>%
  rownames_to_column("Cell_type") %>%
  gather(key = "Stage", value = "cor", -Cell_type) %>%
  mutate(Stage=factor(Stage, levels = c("e10-e11",
                              "e11-e12",
                              "e12-e13",
                              "e13-e15",
                              "e15-e17",
                              "e17-P0",
                              "P0-P4",
                              "P4-P7",
                              "P7-P14",
                              "P14-P63"))) %>%
  mutate(t=as.numeric(Stage)) %>%
  mutate(sample =paste(Cell_type, Stage, sep = "_")) %>%
  filter(sample %in% all.gather$sample) 
```


```{r}
p <- ggplot(cor_adj_by_cell_type.gather, aes(x=t, y=cor, color=Cell_type)) +
  geom_point() +
  geom_line() +
  ylab("Pearson's r") +
  xlab("Development") +
  scale_color_manual(values = c("#a960a1", "#43bbc8", "#62943c", "#de761d","#d3405a", "#527cde")) +
  scale_x_continuous(breaks = seq(min(cor_adj_by_cell_type.gather$t), max(cor_adj_by_cell_type.gather$t), by = 1), labels=levels(cor_adj_by_cell_type.gather$Stage)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

p

pdf("~/Mouse_Cereb/Figures/004_devPeaks/Mouse_cerebellum_broadCellTypes_PearonsCorrelations_acrossAdjacentStages.pdf", width = 6, height = 4, useDingbats = F); print(p); dev.off()
```

Indeed, we see a drop in correlations (within cell types) in e11-e13, to some degree in P0-P4, and very clearly in the last two periods (P7-P14, P14-P63).

```{r}
sessionInfo()
```

